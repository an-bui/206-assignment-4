---
title: "Final report"
author: "An Bui, Sam Csik"
date: "11/14/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#### Introduction

The California spiny lobster, *Panulirus interruptus*, ranges from Monterey Bay, California, to the southern tip of the Baja California peninsula in temperate-subtropical waters (Lindberg 1955, Vega Velázquez 2003). As adults, they inhabit rocky reef, intertidal, and kelp forest habitats, emerging from shelters at night to forage primarily on benthic invertebrates including mussels (Robles et al. 1990) and red and purple urchins (Tegner & Levin 1983). As predators, lobsters can have important impacts on prey populations; they have been shown to limit the density and sizes of mussels in rocky intertidal regions in Southern California (Robles 1987, Robles et al. 1990, Robles & Robb 1993, Robles 1997, Robles et al. 2001) and may indirectly impact giant kelp by releasing it from urchin grazing pressure (Tegner & Levin 1983, Halpern et al. 2006, Eurich et al. 2014).  

- importance of size/what means for reproduction  

- expand fisheries portion
CA spiny lobsters are highly valued as a commercially important resource across their range, generating an estimated $18.7 million in the 2014-15 fishing season in the United States alone. (CDFW 2016). 

#### Methods
- add a map
- MPA info
Lobster surveys began in 2012 and were conducted annually as part of a long-term monitoring effort within Santa Barbara Coastal Long Term Ecological Research (SBC LTER) sites. Lobster count and sizes are recorded on four 60 x 5m transects approximately 1km offshore at five sites in the SBC LTER (figure 1, throw in a map?). Two of these sites (Isla Vista, Naples Reef) are in Marine Protected Areas (MPA), while three (Arroyo Quemado, Carpinteria, Mohawk) are not. Comparing MPA and non-MPA sites allows us to elucidate the effects of fishing on lobster abundance. When integrating these surveys with algal and invertebrate surveys also being conducted at these sites, we are able to construct a holistic profile of kelp forest community dynamics in response to fishing pressure.

The following report analyzes lobster abundances and sizes at five SBC LTER locations, two of which are MPAs (Isla Vista, Naples Reef), and three non-MPA (Arroyo Quemado, Carpenteria, Mohawk). We find that ________.  

#### Results and Discussion
```{r set up packages and data frames, include = FALSE}
# load required packages
library(Rmisc)
library(vcdExtra)
library(tidyverse)
library(ggsignif)
library(effsize)
library(car)
library(kableExtra)
library(onewaytests)
library(reshape2)
library(lemon)
library(ggpubr)

# read in lobster_size_abundance.csv file and get into tidy format
size_abund <- read_csv("lobster_size_abundance.csv")

abund <- as.data.frame(size_abund) %>% 
  expand.dft(freq = "COUNT") # expands freq. table to df representing individual obs. in the table

# read in lobster_traps.csv file and get into tidy format
traps_master <- read_csv("lobster_traps.csv")

traps <- as.data.frame(traps_master) %>% 
  expand.dft(freq = "TRAPS")
```

### Lobster abundance and fishing pressure between 2012 and 2017
```{r trends in lob abundance and fishing pressure}
# PART 1. DESCRIBE TRENDS IN LOBSTER ABUNDANCE AND FISHING PRESSURE AT THE 5 LOCATIONS FROM 2012-2017

#############################
#  calculate mean abundance by year for each site
##############################
abund_by_yearssite <- abund %>% 
  group_by(YEAR, SITE) %>% # group by year, then site
  summarize(
    count = length(SIZE) # sample size by site
  ) %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, SITE, site_full, count) # select and reorder columns

##############################
#  calculate mean fishing pressure by year for each site
##############################

traps_by_yearssite <- traps %>% 
  select(YEAR, SITE, SWATH_START, SWATH_END) %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL") %>% 
  group_by(YEAR, SITE) %>% # group by year, then site
  summarize(
    count = length(SWATH_START) # number of traps by site
  ) %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, SITE, site_full, count) # select and reorder columns

##############################
# plot trends in lobster abundance AND fishing pressure by site thorugh time TOGETHER on same plot
##############################

abund_by_yearssite$site_full <- factor(abund_by_yearssite$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

traps_by_yearssite$site_full <- factor(traps_by_yearssite$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

caption1 <- paste(strwrap("Figure 1. Lobster abundance and fishing pressure at five locations in the Santa Barbara Channel (2017). Lobster abundance (solid lines) estimated annually on transects conducted via SCUBA at five locations. Fishing pressure is estimated by counting the number of lobster trap floats (dashed lines) in definded ares of coastline every 2 - 4 weeks during the fishing season. MPAs (green) were designated in 2012. Unprotected areas (yellow) are fished annually. Data from Reed (2017).", width = 110), collapse = "\n")

#pdf("fig_1.pdf", width = 8, height = 6)
abund_traps_plot <- ggplot(abund_by_yearssite, aes(x = YEAR, y = count)) +
  geom_point(color = "gray30") +
  geom_line(color = "gray30") +
  geom_point(data = traps_by_yearssite, color = "gray30") +
  geom_line(data = traps_by_yearssite, linetype = "dashed", color = "gray30") +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
        panel.border = element_rect(colour = "black", fill=NA, size=0.7), 
        strip.background = element_rect(fill = "grey"),
        plot.caption = element_text(size = 10, hjust = 0)) +
  facet_grid(~site_full) +
  labs(x = "Year", y = "Counts", caption = caption1) +
  scale_x_continuous(breaks=c(2013, 2015, 2017))
abund_traps_plot
#dev.off()
```

### Lobster size in 2017 inside and outside MPAs
```{r compare mean lob size in 2017}
# PART 2. COMPARE MEAN LOBSTER SIZE BY SITE IN 2017

##############################
# wrangle data for 2017
##############################

abund_2017 <- abund %>% 
  filter(YEAR == "2017",
         SIZE != "-99999") %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, SITE, site_full, SIZE)

##############################
# test for variances, ANOVA, Tukey's HSD
##############################

lob_variances <- abund_2017 %>% 
  group_by(SITE) %>% 
  summarize(
    lob_var = var(SIZE)
  )

lob_variances 
# largest variance is no greater than 4x smallest variance

size_anova <- aov(SIZE ~ SITE, data = abund_2017)
summary(size_anova)

size_ph <- TukeyHSD(size_anova)
size_ph  # so the only ones that are different are NAPL-CARP and NAPL-IVE

##############################
# box and whisker plot of size
##############################

abund_2017$site_full <- factor(abund_2017$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef")) # make site_full a factor to reorder on plot

caption2 <- paste(strwrap("Figure 2. Carapace lengths (CL, mm) of CA spiny lobster at five locations in the Santa Barbara Channel (2017). CL estimated on SCUBA in study transects at five locations: Isla Vista, Naples Reef, Arroyo Quemado, Carpenteria, Mohawk. MPAs (green) were designated in 2012. Unprotected areas (yellow) are fished annually. Dashed line represents the mean CL across all five sites in 2017. Mean CL only differed significantly between Naples Reef-Isla Vista (_p_ = 0.004) and Naples Reef-Carpenteria (_p_ = 0.02). All other pairwise comparisons yielded no signficant differences (one-way ANOVA, F(4) = 3.42, p < 0.01) with post-hoc Tukey's HSD (alpha = 0.05). Data from Reed (2017).", width = 110), collapse = "\n")

#stats <- summarySE(abund_2017, measurevar = "SIZE", groupvars = c("site_full"), na.rm = TRUE) # also need to insert "stats" into ggplot argument, but isn't working correctly

pdf("fig_2.pdf", width = 8, height = 6)
size_2017_boxplot <- ggplot(abund_2017, aes(x = site_full, y = SIZE)) +
  geom_boxplot(fill = "darkgrey") +
  geom_hline(yintercept = 82.6, linetype = 2) + # add line at CL mean across sites
  geom_signif(comparisons = list(c("Isla Vista", "Naples Reef"), c("Naples Reef", "Carpinteria")),
              map_signif_level = TRUE) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"),
        panel.border = element_rect(colour = "black", fill=NA, size=0.8),
        legend.position = "none",
        plot.caption = element_text(size = 10, hjust = 0)) +
  labs(x = "Site", y = "Carapace Length (mm)", caption = caption2)

size_2017_boxplot
dev.off()
```

```{r comparing lob sizes in 2012 and 2017}
# PART 3. AT IVEE AND NAPL (MPAs), HOW DO LOBSTER SIZES IN 2012 AND 2017 COMPARE? AT NON-MPA SITES?

##############################
# subset data by site and year (2012, 2017) to compare sizes at IVEE and NAPL
##############################

size_ivee_2012 <- abund %>%
  filter(SITE == "IVEE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_ivee_2017 <- abund %>% 
  filter(SITE == "IVEE",
         YEAR == "2017") %>% 
  pull(SIZE)

size_napl_2012 <- abund %>%
  filter(SITE == "NAPL",
         YEAR == "2012") %>% 
  pull(SIZE)

size_napl_2017 <- abund %>% 
  filter(SITE == "NAPL",
         YEAR == "2017") %>% 
  pull(SIZE)

##############################
# one-way t-test for IVEE & NAPL
##############################

ivee_t <- t.test(size_ivee_2012, size_ivee_2017, var.equal = TRUE) 
ivee_t # p value = 0.0599, lob means are not sig different between 2012 & 2017 at IVEE (but close to sig...)

napl_t <- t.test(size_napl_2012, size_napl_2017, var.equal = TRUE)
napl_t # p value = 0.5002, lob means are not significantly different between 2012 and 2017 at NAPL

# Mean lobster size does not differ signficantly between 2012 and 2017 at either Isla Vista (t(`r round(ivee_t$parameter, 2)`) = `r round(ivee_t$statistic, 2)`, _p_ = `r round(ivee_t$p.value, 2)`) or Naples Reef (t(`r round(napl_t$parameter, 2)`) = `r round(napl_t$statistic, 2)`, _p_ = `r round(napl_t$p.value, 2)`).

##############################
# subset data by site and year (2012, 2017) to compare sizes at non-MPA sites (AQUE, CARP, MOHK)
##############################

size_aque_2012 <- abund %>%
  filter(SITE == "AQUE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_aque_2017 <- abund %>% 
  filter(SITE == "AQUE",
         YEAR == "2017") %>% 
  pull(SIZE)

size_carp_2012 <- abund %>%
  filter(SITE == "CARP",
         YEAR == "2012") %>% 
  pull(SIZE)

size_carp_2017 <- abund %>% 
  filter(SITE == "CARP",
         YEAR == "2017") %>% 
  pull(SIZE)

size_mohk_2012 <- abund %>%
  filter(SITE == "MOHK",
         YEAR == "2012") %>% 
  pull(SIZE)

size_mohk_2017 <- abund %>% 
  filter(SITE == "MOHK",
         YEAR == "2017") %>% 
  pull(SIZE)

##############################
# one-way t-test for non-MPA sites
##############################

aque_t <- t.test(size_aque_2012, size_aque_2017, var.equal = TRUE) # p = 0.2097
carp_t <- t.test(size_carp_2012, size_carp_2017, var.equal = TRUE) # p = 0.1819
mohk_t <- t.test(size_mohk_2012, size_mohk_2017, var.equal = TRUE) # p < 0.001

# Similarly to MPA sites, non-MPA sites show a similar consistency in lobster carapace length when comparing measurements from 2012 and 2017. Carapace length does not differ significantly between 2012 and 2017 at Arroyo Quemado (t(`r round(aque_t$parameter, 2)`) = `r round(aque_t$statistic, 2)`, _p_ = `r round(aque_t$p.value, 2)`) or Carpinteria (t(`r round(carp_t$parameter, 2)`) = `r round(carp_t$statistic, 2)`, _p_ = `r round(carp_t$p.value, 2)`). However, lobster carapace length does differ significantly between comparison years at Mohawk (t(`r round(mohk_t$parameter, 2)`) = `r round(mohk_t$statistic, 2)`, _p_ = `r round(mohk_t$p.value, 2)`). 

##############################
# wrangle data to make boxplot comparing 2012 & 2017 for each site
##############################

abund_df <- abund %>% 
  group_by(SITE, YEAR) %>% # group by year, then site
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  mutate(protection = case_when(
    SITE == "NAPL" ~ "MPA",
    SITE == "IVEE" ~ "MPA",
    SITE == "AQUE" ~ "Non-MPA",
    SITE == "CARP" ~ "Non-MPA",
    SITE == "MOHK" ~ "Non-MPA")) %>% 
  mutate(site_full = case_when( 
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )) %>% 
  select(YEAR, SITE, site_full, SIZE, protection)

##############################
# boxplot of sizes in 2012 & 2017 in MPA & non-MPA sites
##############################

abund_df$site_full <- factor(abund_df$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

caption3 <- paste(strwrap("Figure 3. Carapace lengths (CL, mm) of CA spiny lobster at five locations in the Santa Barbara Channel (2012 & 2017). CL estimated on SCUBA in study transects at five locations: Isla Vista, Naples Reef, Arroyo Quemado, Carpenteria, Mohawk. MPAs (green) were designated in 2012. Unprotected areas (yellow) are fished annually. One-way t-tests of CL by site yielded no signficant differences between 2012 & 2017 (one-way test, alpha = 0.05) Data from Reed (2017).", width = 110), collapse = "\n") # fix alpha; bold; how to discuss statistical results?

pdf("fig_3.pdf", width = 8, height = 6)
abund_plot <- ggplot(abund_df, aes(x = YEAR, y = SIZE)) +
  geom_boxplot(aes(group = YEAR, fill = factor(YEAR))) +
  scale_fill_manual(breaks = c("2012", "2017"),values = c("white", "darkgrey"), name = "Year") +
  facet_grid(~ site_full) +
  labs(x = "Site", y = "Carapace Length (mm)", caption = caption3) +
  theme_classic() +
   theme(
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank(),
    #legend.position="none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    strip.background = element_rect(fill = "grey"),
    plot.caption = element_text(size = 10, hjust = 0)) 
abund_plot
dev.off()

##############################
# Cohen's d effect size -- change in CL from 2012-2017 at each site
##############################

napl_d <- cohen.d(size_napl_2012, size_napl_2017, pooled = TRUE) # SMALL increase
ivee_d <- cohen.d(size_ivee_2012, size_ivee_2017, pooled = TRUE) # SMALL increase
aque_d <- cohen.d(size_aque_2012, size_aque_2017, pooled = TRUE) # SMALL increase
carp_d <- cohen.d(size_carp_2012, size_carp_2017, pooled = TRUE) # NEGLIGIBLE decrease
mohk_d <- cohen.d(size_mohk_2012, size_mohk_2017, pooled = TRUE) # MEDIUM decrease

##############################
# absolute differences
##############################

mean_ivee_2012 <- mean(size_ivee_2012)
mean_ivee_2017 <- mean(size_ivee_2017)
change_ivee <- mean_ivee_2017 - mean_ivee_2012 # 5.375 mm increase

mean_napl_2012 <- mean(size_napl_2012)
mean_napl_2017 <- mean(size_napl_2017)
change_napl <- mean_napl_2017 - mean_napl_2012 # 3.232 mm increase

mean_aque_2012 <- mean(size_aque_2012)
mean_aque_2017 <- mean(size_aque_2017)
change_aque <- mean_aque_2017 - mean_aque_2012 # 2.8955 mm increase

mean_carp_2012 <- mean(size_carp_2012)
mean_carp_2017 <- mean(size_carp_2017)
change_carp <- mean_carp_2017 - mean_carp_2012 # 2.129 mm decrease

mean_mohk_2012 <- mean(size_mohk_2012)
mean_mohk_2017 <- mean(size_mohk_2017)
change_mohk <- mean_mohk_2017 - mean_mohk_2012 # 5.253 mm decrease
```

```{r proportion of lobs above legal min}
# PART 4. WHAT PROPORTION OF OBSERVED LOBSTERS AT EACH SITE ARE ABOVE THE LEGAL MINIMUM (82.6mm)

##############################
# make new table with sizes above and below legal limit
##############################

abund_2017_size <- abund_2017 %>% 
  mutate(legal = case_when(
    SIZE > 82.6 ~ "above",
    SIZE < 82.6 ~ "below"
  )) %>% 
  count(SITE, legal) %>% 
  spread(legal, n) %>% 
  select(-SITE)

rownames(abund_2017_size) <- c("Arroyo Quemado", "Carpinteria", "Isla Vista Reef", "Mohawk", "Naples Reef")
  
##############################
# x2 test
##############################

lob_prop <- round(prop.table(as.matrix(abund_2017_size), 1), 3)*100
lob_prop

lob_prop_columns = c("Above", "Below")

lob_prop_caption = "**Table 2. Proportions of lobsters above and below legal limit in 2017.** The legal length of fished lobsters is 82.6mm."

kable(lob_prop,
      col.names = lob_prop_columns,
      caption = lob_prop_caption) %>% 
  kable_styling(bootstrap_options = "striped")

# how to add column name to site? need to create new data frame?
# going to try to figure out how to add a table that has counts with proportions

lob_x2 <- chisq.test(abund_2017_size)
lob_x2
# The proportion of legal size lobsters is significantly different amongst sites ($\chi^2$(`r lob_x2$parameter)) = `r round(lob_x2$statistic, 2`), _p_ < 0.001). 
```

