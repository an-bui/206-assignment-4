---
title: "Final report"
author: "An Bui, Sam Csik"
date: "11/14/2018"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Introduction

FROM METHODS--REARRANGE AND EXPAND
The California spiny lobster, *Panulirus interruptus*, ranges from Monterey Bay, California, to the southern tip of the Baja California peninsula in temperate-subtropical waters (Lindberg 1955, Vega Velázquez 2003). As adults, they inhabit rocky reef, intertidal, and kelp forest habitats, emerging from shelters at night to forage primarily on benthic invertebrates including mussels (Robles et al. 1990) and red and purple urchins (Tegner & Levin 1983). As predators, lobsters can have important impacts on prey populations; they have been shown to limit the density and sizes of mussels in rocky intertidal regions in Southern California (Robles 1987, Robles et al. 1990, Robles & Robb 1993, Robles 1997, Robles et al. 2001) and may indirectly impact giant kelp by releasing it from urchin grazing pressure (Tegner & Levin 1983, Halpern et al. 2006, Eurich et al. 2014). 

CA spiny lobsters are highly valued as a commercially important resource across their range, generating an estimated $18.7 million in the 2014-15 fishing season in the United States alone. (CDFW 2016). 

The following report analzyes lobster abundances and sizes at five SBC LTER locations, two of which are MPAs (Isla Vista, Naples Reef), and three non-MPA (Arroyo Quemado, Carpenteria, Mohawk). We find that ________.

```{r, include = FALSE}
# load required packages
library(tidyverse)
library(car)
library(vcdExtra)
library(kableExtra)
library(onewaytests)
library(reshape2)
library(lemon)
library(wesanderson)

# read in lobster_size_abundance.csv file and get into tidy format
size_abund <- read_csv("lobster_size_abundance.csv")

abund <- as.data.frame(size_abund) %>% 
  expand.dft(freq = "COUNT") # expands freq. table to df representing individual obs. in the table

# read in lobster_traps.csv file and get into tidy format
traps_master <- read_csv("lobster_traps.csv")

traps <- as.data.frame(traps_master) %>% 
  expand.dft(freq = "TRAPS")
```


```{r}
# PART 1. DESCRIBE TRENDS IN LOBSTER ABUNDANCE AND FISHING PRESSURE AT THE 5 LOCATIONS FROM 2012-2017

#############################
#  calculate mean abundance by year for each site
##############################
abund_by_yearssite <- abund %>% 
  group_by(YEAR, SITE) %>% # group by year, then site
  summarize(
    count = length(SIZE) # sample size by site
  ) %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, site_full, count) # select and reorder columns

##############################
#  calculate mean fishing pressure by year for each site
##############################

traps_by_yearssite <- traps %>% 
  select(YEAR, SITE, SWATH_START, SWATH_END) %>% 
  filter(SITE == "AQUE" | SITE == "CARP" | SITE == "IVEE" | SITE == "MOHK" | SITE == "NAPL") %>% 
  group_by(YEAR, SITE) %>% # group by year, then site
  summarize(
    count = length(SWATH_START) # number of traps by site
  ) %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, site_full, count) # select and reorder columns

##############################
# plot trends in lobster abundance AND fishing pressure by site thorugh time TOGETHER on same plot
##############################


abund_by_yearssite$site_full <- factor(abund_by_yearssite$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

traps_by_yearssite$site_full <- factor(traps_by_yearssite$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

abund_traps_plot <- ggplot(abund_by_yearssite, aes(x = YEAR, y = count)) +
  geom_point(aes(color = site_full)) +
  geom_line(aes(color = site_full)) +
  geom_point(data = traps_by_yearssite, aes(color = site_full)) +
  geom_line(data = traps_by_yearssite, linetype = "dashed", aes(color = site_full)) +
  #scale_y_continuous(sec.axis = trans = NULL, name = "# Traps", breaks = NULL)) +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
          panel.border = element_rect(colour = "black", fill=NA, size=0.7), 
          legend.position = "none") + 
  facet_grid(~site_full) +
  labs(x = "Year", y = "Counts")  +
  scale_color_manual(values = wes_palette(n = 5, name = "Cavalcanti1"))

abund_traps_plot
```

```{r}
# PART 2. COMPARE MEAN LOBSTER SIZE BY SITE IN 2017

##############################
# size table for 2017
##############################
abund_2017 <- abund %>% 
  filter(YEAR == "2017") %>% 
  mutate(site_full = case_when( # expand to full length names
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, SITE, site_full, SIZE)

size_table_2017 <- abund_2017 %>% 
  group_by(SITE) %>% 
  summarize(
    mean = round(mean(SIZE), 2),
    sd = round(sd(SIZE), 2),
    n = length(SIZE)
    ) %>% 
  mutate(
    full_site = case_when(
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "IVEE" ~ "Isla Vista", 
      SITE == "MOHK" ~ "Mohawk",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(full_site, mean, sd, n)

size_table_2017$full_site <- factor(size_table_2017$full_site, levels = c("Isla Vista", "Naples Reef", "Arroyo Quemado", "Mohawk", "Carpinteria"))

size_table_2017_columns = c("Site", "Mean length", "Standard deviation", "Sample size")

kable(size_table_2017,
      col.names = size_table_2017_columns) %>% 
  kable_styling(bootstrap_options = "striped")

##############################
# box and whisker plot of size
##############################

size_2017_boxplot <- ggplot(abund_2017, aes(x = site_full, y = SIZE)) +
  geom_boxplot(aes(fill = site_full)) +
  #geom_jitter() +
  theme_classic() +
  theme(axis.text = element_text(color = "black"), 
          panel.border = element_rect(colour = "black", fill=NA, size=0.8), 
          legend.position = "none") +
  labs(x = "Site", y = "Carapace Length (mm)") +
  scale_fill_manual(values = wes_palette(n = 5, name = "Cavalcanti1"))

size_2017_boxplot

##############################
# test for variances, ANOVA, Tukey's HSD
##############################

lob_variances <- abund_2017 %>% 
  group_by(SITE) %>% 
  summarize(
    lob_var = var(SIZE)
  )

lob_variances 
# largest variance is no greater than 4x smallest variance

size_anova <- aov(SIZE ~ SITE, data = abund_2017)
summary(size_anova)

size_ph <- TukeyHSD(size_anova)
size_ph  # so the only ones that are different are NAPL-CARP and NAPL-IVEE
```

```{r}
# PART 3. AT IVEE AND NAPL (MPAs), HOW DO LOBSTER SIZES IN 2012 AND 2017 COMPARE? AT NON-MPA SITES?

##############################
# subset data by site and year (2012, 2017) to compare sizes at IVEE and NAPL
##############################

size_ivee_2012 <- abund %>%
  filter(SITE == "IVEE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_ivee_2017 <- abund %>% 
  filter(SITE == "IVEE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_napl_2012 <- abund %>%
  filter(SITE == "NAPL",
         YEAR == "2012") %>% 
  pull(SIZE)

size_napl_2017 <- abund %>% 
  filter(SITE == "NAPL",
         YEAR == "2017") %>% 
  pull(SIZE)

##############################
# one-way t-test for IVEE & NAPL
##############################

ivee_t <- t.test(size_ivee_2012, size_ivee_2017, var.equal = TRUE) # idk what's going on with IVEE but did it anyway
ivee_t # p value = 1?? lob means are not significantly different between 2012 and 2017 at IVEE

napl_t <- t.test(size_napl_2012, size_napl_2017, var.equal = TRUE)
napl_t # p value = 0.5373, lob means are not significantly different between 2012 and 2017 at NAPL

# In a report, maybe: Between 2012 and 2017, mean lobster size did not change significantly at either Isla Vista (t(df) = statistic, p = statistic, a = 0.05) or Naples Reef (t(df) = statistic, p = statistic, a = 0.05).

##############################
# subset data by site and year (2012, 2017) to compare sizes at non-MPA sites (AQUE, CARP, MOHK)
##############################

size_aque_2012 <- abund %>%
  filter(SITE == "AQUE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_aque_2017 <- abund %>% 
  filter(SITE == "AQUE",
         YEAR == "2012") %>% 
  pull(SIZE)

size_carp_2012 <- abund %>%
  filter(SITE == "CARP",
         YEAR == "2012") %>% 
  pull(SIZE)

size_carp_2017 <- abund %>% 
  filter(SITE == "CARP",
         YEAR == "2017") %>% 
  pull(SIZE)

size_mohk_2012 <- abund %>%
  filter(SITE == "MOHK",
         YEAR == "2012") %>% 
  pull(SIZE)

size_mohk_2017 <- abund %>% 
  filter(SITE == "MOHK",
         YEAR == "2017") %>% 
  pull(SIZE)

##############################
# one-way t-test for non-MPA sites
##############################

aque_t <- t.test(size_aque_2012, size_aque_2017, var.equal = TRUE) # p = 1
carp_t <- t.test(size_carp_2012, size_carp_2017, var.equal = TRUE) # p = 0.18
mohk_t <- t.test(size_mohk_2012, size_mohk_2017, var.equal = TRUE) # p < 0.001

##############################
# wrangle data to make boxplot comparing 2012 & 2017 for each site
##############################

abund_df <- abund %>% 
  group_by(SITE, YEAR) %>% # group by year, then site
  filter(YEAR == "2012" | YEAR == "2017") %>% 
  mutate(protection = case_when(
    SITE == "NAPL" ~ "mpa",
    SITE == "IVEE" ~ "mpa",
    SITE == "AQUE" ~ "non_mpa",
    SITE == "CARP" ~ "non_mpa",
    SITE == "MOHK" ~ "non_mpa")) %>% 
  mutate(site_full = case_when( 
      SITE == "AQUE" ~ "Arroyo Quemado",
      SITE == "CARP" ~ "Carpinteria",
      SITE == "IVEE" ~ "Isla Vista",
      SITE == "MOHK" ~ "Mohawk Reef",
      SITE == "NAPL" ~ "Naples Reef"
    )
  ) %>% 
  select(YEAR, site_full, SIZE, protection)

##############################
# boxplot of sizes in 2012 & 2017 in MPA & non-MPA sites
##############################

abund_df$site_full <- factor(abund_df$site_full, levels=c("Isla Vista", "Naples Reef","Arroyo Quemado", "Carpinteria", "Mohawk Reef"))

#pdf("fig_3.pdf", width = 8, height = 6)
abund_plot <- ggplot(abund_df, aes(x = YEAR, y = SIZE)) +
  geom_boxplot(aes(group = YEAR, fill = factor(YEAR))) +
  scale_fill_manual(breaks = c("2012", "2017"),values = c("white", "darkgrey"), name = "Year") +
  facet_grid(~ site_full) +
  labs(x = "Site", y = "Carapace Length (mm)") +
  theme_classic() +
   theme(
    axis.title.x=element_blank(),
    axis.text.x=element_blank(),
    axis.ticks.x=element_blank(),
    #legend.position="none",
    panel.border = element_rect(colour = "black", fill=NA, size=0.7),
    strip.background = element_rect(fill = "grey")
  ) 
abund_plot
#dev.off()
  
  
# grid.brackets(220, bottom_y,80, bottom_y, lwd=2, col="red")
# 
# grid.locator("native")
# bottom_y = 154.125
```

```{r}
# PART 4. WHAT PROPORTION OF OBSERVED LOBSTERS AT EACH SITE ARE ABOVE THE LEGAL MINIMUM (82.6mm)

##############################
# make new table with sizes above and below legal limit
##############################

abund_2017_size <- abund_2017 %>% 
  mutate(legal = case_when(
    SIZE > 82.6 ~ "below",
    SIZE < 82.6 ~ "above"
  )) %>% 
  count(SITE, legal) %>% 
  spread(legal, n) %>% 
  select(-SITE)

rownames(abund_2017_size) <- c("Arroyo Quemado", "Carpinteria", "Isla Vista Reef", "Mohawk", "Naples Reef")
  
##############################
# x2 test
##############################

lob_prop <- prop.table(as.matrix(abund_2017_size), 1)
lob_prop

lob_x2 <- chisq.test(abund_2017_size)
lob_x2
# proportion of legal size lobs differs significantly amongst sites
```

